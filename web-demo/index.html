<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Medicare Advantage Carrier Lookup (Static JSON)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --border:#e5e7eb; --muted:#666; --bg:#f9fafb; --bg-hover:#f3f4f6; --danger:#b00; --pad:24px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: var(--pad); }
    h1 { margin: 0 0 16px; font-size: 20px; }
    label { margin-right: 12px; display: inline-flex; gap: 8px; align-items: center; }
    input, select, button { font-size: 16px; padding: 6px 10px; }
    button { cursor: pointer; }
    #msg { margin: 16px 0; color: var(--danger); white-space: pre-wrap; }
    #out { margin-top: 12px; }
    .row { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .carrier { padding: 8px 0; border-bottom: 1px solid #eee; }
    .badge { font-size: 12px; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; margin-left: 6px; }
    .muted { color: var(--muted); font-size: 13px; }
    .btn-secondary { border:1px solid var(--border); background:#fafafa; border-radius:8px; padding:6px 10px; font-size:13px; }

    /* plan chip */
    .plan-chip {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 3px 8px; margin: 4px 6px 0 0;
      border: 1px solid var(--border); border-radius: 9999px;
      background: var(--bg); font-size: 12px; cursor: pointer; user-select: none;
    }
    .plan-chip:hover { background: var(--bg-hover); }
    .carrier .name { cursor: pointer; }

    /* ---- Drawer styles (mirrors plan-viewer.css so this file is self-sufficient) ---- */
    #pv-drawer {
      position: fixed; top: 0; right: 0; height: 100vh; width: min(720px, 95vw);
      background: #fff; border-left: 1px solid #e5e7eb; box-shadow: -10px 0 25px rgba(0,0,0,0.08);
      transform: translateX(100%); transition: transform 0.25s ease-in-out; z-index: 9999;
      display: flex; flex-direction: column; font-family: inherit;
    }
    #pv-drawer.open { transform: translateX(0); }
    #pv-header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #f3f4f6; }
    #pv-title { font-weight:600; font-size:16px; }
    #pv-actions { display:flex; gap:8px; }
    .pv-btn { border:1px solid #e5e7eb; background:#f9fafb; border-radius:8px; padding:6px 10px; font-size:12px; cursor:pointer; }
    .pv-btn:hover { background:#f3f4f6; }
    #pv-body { overflow:auto; padding:8px 16px 24px; height:100%; }
    #pv-meta { display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:6px 12px; margin:8px 0 12px; }
    .pv-kv { border:1px solid #f3f4f6; border-radius:8px; padding:8px; background:#fafafa; font-size:12px; }
    .pv-kv .k { color:#6b7280; display:block; margin-bottom:2px; }
    #pv-tabs { display:flex; border-bottom:1px solid #f3f4f6; margin:8px 0 12px; }
    .pv-tab { padding:8px 12px; margin-bottom:-1px; border:1px solid transparent; border-top-left-radius:8px; border-top-right-radius:8px; cursor:pointer; font-size:13px; }
    .pv-tab.active { background:#fff; border:1px solid #e5e7eb; border-bottom-color:#fff; }
    #pv-content > .pv-panel { display:none; }
    #pv-content > .pv-panel.active { display:block; }
    .pv-tree { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; line-height:1.45; }
    .pv-tree details { padding-left: 12px; margin-left: 12px; border-left: 1px dashed #e5e7eb; }
    .pv-tree summary { cursor:pointer; list-style:none; }
    .pv-tree .pv-leaf { padding-left:28px; }
    .pv-muted { color:#6b7280; }
    .pv-toast { position: fixed; bottom: 16px; right: 16px; background: #111827; color: white; padding: 8px 12px; border-radius: 8px; font-size: 12px; z-index: 10000; opacity: .98; }
    pre.dump { font: 12px/1.5 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#fafafa; border:1px solid #eee; padding:10px; border-radius:8px; white-space:pre-wrap; }
  </style>

  <!-- External assets assumed to be in web-demo/ alongside this file -->
  <link rel="stylesheet" href="plan-viewer.css" />
  <script src="plan-viewer.js" defer></script>
  <script src="plan-picker.js" defer></script>
</head>

<body>
  <h1>Medicare Advantage Carrier Lookup (Static JSON)</h1>

  <div role="form" aria-label="Lookup" class="row">
    <label for="zip">ZIP
      <input id="zip" placeholder="e.g., 55379" inputmode="numeric" maxlength="5" />
    </label>
    <label for="year">Year
      <select id="year">
        <option value="2025" selected>2025</option>
      </select>
    </label>
    <button id="go" type="button">Lookup</button>
    <button id="dump" type="button" class="btn-secondary" title="Print all embedded plan JSON below">Show all plan JSON (dump)</button>
  </div>

  <div id="msg" class="muted" aria-live="polite"></div>
  <div id="out"></div>
  <div id="dumpZone"></div>

  <!-- Drawer markup (PlanViewer.js will reuse this) -->
  <div id="pv-drawer" aria-hidden="true">
    <div id="pv-header">
      <div id="pv-title">Plan Details</div>
      <div id="pv-actions">
        <button class="pv-btn" id="pv-download">Download JSON</button>
        <button class="pv-btn" id="pv-copy">Copy JSON</button>
        <button class="pv-btn" id="pv-close">Close</button>
      </div>
    </div>
    <div id="pv-body">
      <div id="pv-meta"></div>
      <div id="pv-tabs">
        <div class="pv-tab active">Summary</div>
        <div class="pv-tab">Raw JSON</div>
        <div class="pv-tab">Flat Table</div>
      </div>
      <div id="pv-content">
        <div class="pv-panel active" id="pv-summary"></div>
        <div class="pv-panel" id="pv-raw"></div>
        <div class="pv-panel" id="pv-flat"></div>
      </div>
    </div>
  </div>

  <script type="module">
    // ---------- Utilities ----------
    const $ = (id) => document.getElementById(id);
    const setMsg = (t, color='#b00') => { const m = $('msg'); m.style.color=color; m.textContent = t; };
    const info = (t) => setMsg(t, '#555');

    if (location.protocol === 'file:') {
      info('⚠️ file:// detected. Use a local server (e.g., `npx serve`) so fetch() can load JSON.');
    }

    // Compute BASE. If path contains /web-demo/, strip from there up to file name.
    const BASE = (() => {
      const { origin, pathname } = location;
      const m = pathname.match(/^(.*?)(\/web-demo\/.*)$/);
      if (m) return origin + m[1] + '/';
      return origin + pathname.replace(/[^/]*$/, ''); // current dir
    })();
    console.log('[BASE]', BASE);

    const normalizeZip = (z) => String(z ?? '').replace(/\D/g, '').padStart(5, '0');
    const fetchJson = async (url) => {
      console.log('[fetch]', url);
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) throw new Error(`${r.status} ${r.statusText} @ ${url}`);
      return r.json();
    };
    const loadZipIndex = (year) => fetchJson(`${BASE}years/${year}/zip-index.json`);

    // ---------- Drawer helpers (hook into your PlanViewer) ----------
    // Buttons on the static drawer shell
    (function wireDrawerButtons(){
      const toast = (t)=>{ const d=document.createElement('div'); d.className='pv-toast'; d.textContent=t; document.body.appendChild(d); setTimeout(()=>d.remove(),2200); };
      $('pv-close').onclick = ()=> document.getElementById('pv-drawer')?.classList.remove('open');
      $('pv-copy').onclick = ()=> {
        try {
          const d = (window.PlanViewer && window.PlanViewer.__debug?.lastData) || null;
          if (d) { navigator.clipboard.writeText(JSON.stringify(d, null, 2)); toast('Copied JSON'); }
        } catch {}
      };
      $('pv-download').onclick = ()=> {
        try {
          const d = (window.PlanViewer && window.PlanViewer.__debug?.lastData) || null;
          const meta = (window.PlanViewer && window.PlanViewer.__debug?.lastMeta) || null;
          if (!d) return;
          const a = document.createElement('a');
          a.href = URL.createObjectURL(new Blob([JSON.stringify(d, null, 2)], { type:'application/json' }));
          a.download = (meta?.downloadName || 'plan') + '.json';
          document.body.appendChild(a); a.click(); a.remove();
        } catch {}
      };
    })();

    // ---------- Full-plan loader (robust) ----------
    const pad3 = (v) => String(v ?? '').replace(/\D/g, '').padStart(3, '0');

    function extractIds(plan) {
      const year = $('year')?.value || '2025';
      const contract = (plan.contract || plan.contractId || plan.contract_id || plan.ContractID || '').toString().toUpperCase().trim();
      const pbp = pad3(plan.pbp ?? plan.planId ?? plan.plan_id ?? plan.PBP ?? '');
      const segment = pad3(plan.segmentId ?? plan.segment_id ?? plan.segment ?? '000');
      const cmsKey = plan.cmsPlanKey || plan.CMSPlanKey || `${year}-${contract}-${pbp}-${segment}`;
      return { year, contract, pbp, segment, cmsKey };
    }

    function planPaths(base, { year, contract, pbp, segment, cmsKey }) {
      const y = year, c = contract, p = pbp, s = segment || '000';
      return [
        // With segment (most complete)
        `${base}years/${y}/by-plan/${c}-${p}-${s}.json`,
        `${base}years/${y}/plan-details/${c}-${p}-${s}.json`,
        `${base}years/${y}/plans/${c}-${p}-${s}.json`,
        `${base}years/${y}/by-plan/${c}/${p}-${s}.json`,
        `${base}years/${y}/by-plan/${c}/${p}/${s}.json`,
        `${base}years/${y}/plans/${c}/${p}-${s}.json`,
        `${base}years/${y}/plans/${c}/${p}/${s}.json`,
        // CMS Plan Key
        `${base}years/${y}/by-plan/${cmsKey}.json`,
        `${base}years/${y}/plan-details/${cmsKey}.json`,
        `${base}years/${y}/plans/${cmsKey}.json`,
        // Without segment
        `${base}years/${y}/by-plan/${c}-${p}.json`,
        `${base}years/${y}/plan-details/${c}-${p}.json`,
        `${base}years/${y}/plans/${c}-${p}.json`,
        `${base}years/${y}/by-plan/${c}/${p}.json`,
        `${base}years/${y}/plans/${c}/${p}.json`,
        // Minified variants sometimes exist
        `${base}years/${y}/by-plan/${c}-${p}-${s}.min.json`,
        `${base}years/${y}/by-plan/${c}-${p}.min.json`,
      ];
    }

    async function loadFullPlan(planOrIds) {
      const ids = ('contract' in planOrIds && 'pbp' in planOrIds && 'year' in planOrIds)
        ? planOrIds
        : extractIds(planOrIds);

      const urls = planPaths(BASE, ids);
      const errors = [];
      for (const u of urls) {
        try {
          const res = await fetch(u, { cache: 'no-store' });
          if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
          return { json: await res.json(), url: u };
        } catch (e) {
          errors.push(`${u} → ${e.message}`);
        }
      }
      throw new Error(`No plan JSON found.\nTried:\n- ${errors.join('\n- ')}`);
    }

    // Expose to PlanPicker.js (so carrier-name modal also pulls full files)
    window.__loadPlanJSON = async (contract, pbp, year, segment='000', cmsKey=null) => {
      const ids = {
        contract: (contract||'').toString().toUpperCase().trim(),
        pbp: pad3(pbp),
        year: year || $('year')?.value || '2025',
        segment: pad3(segment||'000'),
        cmsKey: cmsKey || `${year || $('year')?.value || '2025'}-${(contract||'').toString().toUpperCase().trim()}-${pad3(pbp)}-${pad3(segment||'000')}`
      };
      return loadFullPlan(ids);
    };

    // ---------- Render ----------
    let LAST_COUNTY = null;

    function renderCountySummary(parent, county) {
      LAST_COUNTY = county;
      parent.innerHTML = '';
      if (!county) return setMsg('County JSON empty.');

      const header = document.createElement('h3');
      header.textContent = `${county.county_name}, ${county.state} — ${(county.carriers?.length ?? 0)} carriers`;
      parent.appendChild(header);

      const carriers = county.carriers ?? [];
      if (!carriers.length) { return setMsg('No carriers found in county JSON.'); }

      carriers.forEach(c => {
        const row = document.createElement('div');
        row.className = 'carrier';

        const top = document.createElement('div'); top.className='row';

        const name = document.createElement('strong');
        name.className = 'name';
        name.textContent = c.orgName || 'Carrier';
        name.title = 'Click to choose a plan';
        name.tabIndex = 0;
        name.addEventListener('click', () => {
          const plans = Array.isArray(c.plans) ? c.plans : [];
          if (window.PlanPicker?.open) {
            PlanPicker.open(plans, { title: `${c.orgName || 'Carrier'} — choose a plan` });
          } else {
            // Minimal fallback: open the first plan
            if (plans[0]) {
              const { contract, pbp } = extractIds(plans[0]);
              loadFullPlan(plans[0]).then(({json,url})=>{
                window.PlanViewer?.show?.({ __provenance:url, ...json }, { title:`${contract} - ${pbp}`, hint:`source: ${url}` });
              }).catch(()=> window.PlanViewer?.show?.(plans[0], { title:`${contract} - ${pbp}`, hint:'source: county JSON (fallback)' }));
            }
          }
        });
        name.addEventListener('keydown', (e) => { if (e.key==='Enter'||e.key===' ') { e.preventDefault(); name.click(); } });

        const contracts = document.createElement('span');
        contracts.className = 'badge';
        const idsTxt = Array.isArray(c.contractIds) ? c.contractIds.join(', ') : '';
        contracts.textContent = idsTxt;

        const count = document.createElement('span');
        count.className = 'muted';
        const plansArray = (c.plans ?? []);
        const n = plansArray.length;
        count.textContent = ` — ${n} plan${n === 1 ? '' : 's'}`;

        top.appendChild(name);
        if (idsTxt) top.appendChild(contracts);
        top.appendChild(count);
        row.appendChild(top);

        if (n) {
          const chips = document.createElement('div');
          plansArray.forEach(p => {
            const chip = document.createElement('button');
            chip.type = 'button';
            chip.className = 'plan-chip';

            const ids = extractIds(p);
            const premium = p.premium ?? p.monthly_premium ?? p.premiumMonthly ?? p.premium_total ?? null;
            chip.textContent = `${ids.contract} ${ids.pbp}${premium!=null ? ` — $${Number(premium).toFixed(2)}/mo` : ''}`;

            // When available, prefer full file; fallback to embedded county object.
            const loader = async () => {
              try {
                const { json, url } = await loadFullPlan(p);
                return { __provenance: url, ...json };
              } catch (e) {
                console.warn('Full plan JSON not found; using county object', ids.contract, ids.pbp, e);
                return { __provenance: 'county JSON (fallback)', ...p };
              }
            };

            if (window.PlanViewer?.register) {
              PlanViewer.register(chip, loader, {
                title: `${ids.contract} - ${ids.pbp}`,
                hint: 'Prefers full plan file; falls back to county JSON'
              });
            } else {
              chip.addEventListener('click', async () => {
                const data = await loader();
                window.PlanViewer?.show?.(data, { title: `${ids.contract} - ${ids.pbp}`, hint: data.__provenance });
              });
            }
            chips.appendChild(chip);
          });
          row.appendChild(chips);
        } else {
          const none = document.createElement('div');
          none.className = 'muted';
          none.textContent = 'No plans listed for this carrier.';
          row.appendChild(none);
        }

        parent.appendChild(row);
      });
    }

    async function lookup() {
      $('msg').textContent = ''; $('out').innerHTML = ''; $('dumpZone').innerHTML = '';
      const year = $('year').value;
      const zip = normalizeZip($('zip').value);
      if (!/^\d{5}$/.test(zip)) return setMsg('Please enter a 5-digit ZIP.');

      try {
        const idx = await loadZipIndex(year);
        const rec = idx.find(e => e.zip === zip);
        if (!rec) return setMsg(`ZIP ${zip} is not in the index. Try a nearby residential ZIP (not PO Box).`);
        if (!(rec.counties?.length)) return setMsg(`ZIP ${zip} returned no counties.`);

        const [fips] = rec.counties[0];
        const countyUrl = `${BASE}years/${year}/by-county/${fips}.json`;
        const county = await fetchJson(countyUrl);
        renderCountySummary($('out'), county);

        if (rec.counties.length > 1) {
          const hint = document.createElement('div');
          hint.className = 'muted';
          const other = rec.counties.slice(1).map(([f]) => f).join(', ');
          hint.textContent = `Note: ZIP ${zip} spans multiple counties; showing top match FIPS ${fips}. Others: ${other || '—'}.`;
          $('out').appendChild(hint);
        }
        info(`Loaded county ${fips}. Click a carrier or plan chip.`);
      } catch (e) {
        console.error(e); setMsg('Error: ' + (e?.message || e));
      }
    }

    function dumpAllPlans() {
      $('dumpZone').innerHTML = '';
      if (!LAST_COUNTY) { return setMsg('Load a ZIP first, then click "Show all plan JSON".'); }
      const carriers = LAST_COUNTY.carriers ?? [];
      const allPlans = carriers.flatMap(c => Array.isArray(c.plans) ? c.plans : []);
      if (!allPlans.length) { return setMsg('This county JSON does not embed plan objects. No plan data to dump.'); }
      const pre = document.createElement('pre'); pre.className='dump';
      pre.textContent = JSON.stringify(allPlans, null, 2);
      $('dumpZone').appendChild(pre);
      info(`Dumped ${allPlans.length} plan objects below.`);
    }

    // ---------- Boot ----------
    window.addEventListener('DOMContentLoaded', () => {
      // Initialize your viewer if present
      if (typeof window.PlanViewer?.init === 'function') { try { window.PlanViewer.init(); } catch {} }

      $('go').addEventListener('click', lookup);
      $('zip').addEventListener('keydown', (e) => { if (e.key === 'Enter') lookup(); });
      $('dump').addEventListener('click', dumpAllPlans);
    });
  </script>
</body>
</html>

