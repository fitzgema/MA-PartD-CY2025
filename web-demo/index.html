<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Medicare Advantage Carrier Lookup (Static JSON)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#0b1220; --panel:#0f172a; --ink:#e5e7eb; --muted:#94a3b8; --accent:#60a5fa;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --border:#1e293b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0a0f1a);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;z-index:10;background:rgba(10,15,26,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .topbar{display:flex;gap:16px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:12px;align-items:center}
    .dot{width:12px;height:12px;border-radius:12px;background:linear-gradient(135deg,#34d399,#60a5fa)}
    h1{font-size:18px;margin:0;font-weight:600}
    nav{display:flex;gap:8px;flex-wrap:wrap}
    .tab{border:1px solid var(--border);background:#0f172a;padding:10px 12px;border-radius:10px;cursor:pointer}
    .tab[aria-selected="true"]{border-color:#2b3b55; background:#111b2e; outline:2px solid #1d4ed8}
    main{padding:20px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .grow{flex:1 1 auto}
    input,select{background:#0b1426;color:var(--ink);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
    th{font-weight:600;color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#0b1426;font-size:12px;color:var(--muted)}
    .stat{display:grid;grid-template-columns:auto auto;gap:6px 12px}
    .stat b{color:var(--ink)}
    .hint{color:var(--muted);font-size:13px}
    .empty{padding:24px;border:1px dashed var(--border);border-radius:12px;text-align:center;color:var(--muted)}
    .badge-ok{color:var(--ok)} .badge-warn{color:var(--warn)} .badge-bad{color:var(--bad)}
    footer{color:var(--muted);font-size:12px;margin-top:16px}
    .hidden{display:none !important}
    @media (max-width:700px){ .topbar{flex-direction:column;align-items:flex-start} nav{width:100%} }
  </style>
</head>
<body>
  <header>
    <div class="wrap topbar">
      <div class="brand">
        <span class="dot"></span>
        <h1>Medicare Advantage — Data Explorer</h1>
      </div>
      <nav role="tablist" aria-label="Views">
        <button class="tab" role="tab" data-view="carriers" aria-selected="true">Carriers</button>
        <button class="tab" role="tab" data-view="plans">Plans</button>
        <button class="tab" role="tab" data-view="premiums">Premiums</button>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <!-- Data controls -->
    <section class="panel">
      <div class="row">
        <div class="grow">
          <div class="hint">Load your dataset (auto-attempts <code>data/ma-plans.json</code> on page load). File must be JSON array of plan objects.</div>
        </div>
        <input type="file" id="file" accept=".json" />
        <button id="reload" class="tab" title="Reload default">Reload default</button>
      </div>
      <div id="load-status" class="hint" style="margin-top:8px;"></div>
    </section>

    <!-- Views -->
    <section id="view-carriers" class="panel" style="margin-top:16px">
      <div class="row">
        <div class="grow">
          <h2 style="margin:0 0 4px 0">Carriers overview</h2>
          <div class="hint">Aggregated by <b>Organization</b> (a.k.a. carrier). Shows plan count and premium stats.</div>
        </div>
        <input id="carrier-filter" placeholder="Filter carriers…" />
      </div>
      <div id="carriers-empty" class="empty hidden">No carriers to display.</div>
      <table id="carriers-table" class="hidden">
        <thead>
          <tr>
            <th>Carrier</th>
            <th>Plans</th>
            <th>Avg Premium</th>
            <th>Min</th>
            <th>Max</th>
            <th>States</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section id="view-plans" class="panel hidden" style="margin-top:16px">
      <div class="row">
        <div class="grow">
          <h2 style="margin:0 0 4px 0">Plans</h2>
          <div class="hint">Full list with contract & plan IDs. Columns adapt to keys present in your JSON.</div>
        </div>
        <input id="plan-search" placeholder="Search plans, counties, IDs…" />
        <select id="state-select"><option value="">All States</option></select>
      </div>
      <div id="plans-empty" class="empty hidden">No plans match.</div>
      <table id="plans-table" class="hidden">
        <thead><tr id="plans-head"></tr></thead>
        <tbody id="plans-body"></tbody>
      </table>
    </section>

    <section id="view-premiums" class="panel hidden" style="margin-top:16px">
      <div class="row">
        <div class="grow">
          <h2 style="margin:0 0 4px 0">Premiums</h2>
          <div class="hint">Filter by state and premium range. Premium key auto-detected (e.g., <code>premium</code> or <code>monthlyPremium</code>).</div>
        </div>
        <select id="prem-state"><option value="">All States</option></select>
        <input id="prem-min" type="number" placeholder="Min $" min="0" step="1" style="width:110px" />
        <input id="prem-max" type="number" placeholder="Max $" min="0" step="1" style="width:110px" />
        <button id="prem-clear" class="tab">Clear</button>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="stat">
          <span class="hint">Plans:</span><b id="prem-count">0</b>
          <span class="hint">Avg Premium:</span><b id="prem-avg">$0</b>
          <span class="hint">Min / Max:</span><b id="prem-minmax">$0 — $0</b>
        </div>
      </div>
      <div id="prem-empty" class="empty hidden">No plans in range.</div>
      <table id="prem-table" class="hidden">
        <thead>
          <tr>
            <th>Carrier</th>
            <th>Plan Name</th>
            <th>Contract</th>
            <th>PlanID</th>
            <th>State</th>
            <th>County</th>
            <th>Premium</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <footer class="wrap" style="padding-left:0;padding-right:0">
      <div class="hint">Tip: This page never navigates, so routes won’t 404. Use the tabs above to switch views.</div>
    </footer>
  </main>

  <script>
    // -------- Utilities --------
    const $ = sel => document.querySelector(sel);
    const fmt$ = n => isFinite(n) ? "$" + Number(n).toFixed(2) : "—";
    const by = k => (a,b)=> (a[k]??"").toString().localeCompare((b[k]??"").toString(),undefined,{numeric:true,sensitivity:"base"});
    const toNum = v => {
      if (v==null) return NaN;
      if (typeof v === "number") return v;
      const s = String(v).replace(/[^0-9.\-]/g,'');
      return s ? Number(s) : NaN;
    };

    // -------- State --------
    let RAW = [];              // the raw plans array
    let KEYS = new Set();      // union of keys observed
    let PREMIUM_KEY = null;    // detected premium key
    const STATE_KEY_CANDIDATES = ["state","State","STATE","planState","serviceAreaState"];
    const COUNTY_KEY_CANDIDATES = ["county","County","COUNTY","serviceAreaCounty","countyName"];
    const CARRIER_KEY_CANDIDATES = ["organization","Organization","carrier","Carrier","orgMarketingName","OrganizationMarketingName"];
    const PLANNAME_KEYS = ["planName","PlanName","plan_name","marketingName","MarketingName"];
    const CONTRACT_KEYS = ["contractId","ContractID","contractID","Contract","contract"];
    const PLANID_KEYS = ["planId","PlanID","planID","Plan Number","planNumber"];

    function pickKey(obj, candidates){
      for (const k of candidates){ if (k in obj) return k; }
      return null;
    }

    function detectPremiumKey(sample){
      const candidates = ["premium","Premium","monthlyPremium","MonthlyPremium","memberPremium","Part_C_Premium"];
      for (const k of candidates){ if (k in sample && isFinite(toNum(sample[k]))) return k; }
      // last resort: any key with "premium" in name that parses numeric
      for (const k in sample){
        if (/premium/i.test(k) && isFinite(toNum(sample[k]))) return k;
      }
      return null;
    }

    function unionKeys(arr){
      const s = new Set();
      arr.slice(0,2000).forEach(o => Object.keys(o||{}).forEach(k=>s.add(k)));
      return s;
    }

    // -------- View switching (no navigation => no 404s) --------
    const VIEWS = ["carriers","plans","premiums"];
    function show(view){
      VIEWS.forEach(v=>{
        const selected = v===view;
        document.getElementById(`view-${v}`).classList.toggle("hidden", !selected);
        document.querySelector(`[data-view="${v}"]`).setAttribute("aria-selected", selected ? "true" : "false");
      });
      location.hash = "#"+view;
    }
    document.querySelectorAll('[data-view]').forEach(btn=>{
      btn.addEventListener('click', ()=> show(btn.dataset.view));
    });

    // -------- Data loading --------
    async function tryFetchDefault(){
      setStatus("Loading data from <code>data/ma-plans.json</code> …");
      try{
        const res = await fetch("data/ma-plans.json", {cache:"no-store"});
        if(!res.ok) throw new Error(res.status+" "+res.statusText);
        const json = await res.json();
        setData(json, "Loaded data/ma-plans.json ("+json.length+" plans).");
      }catch(e){
        setStatus('Default load failed. Using <span class="badge-warn">small sample</span> so you can verify UI. Load your real file above when ready.');
        setData(sampleData(), "Sample loaded ("+sampleData().length+" plans).");
      }
    }

    function setStatus(html){ $("#load-status").innerHTML = html; }
    function setData(arr, msg){
      RAW = Array.isArray(arr) ? arr : [];
      KEYS = unionKeys(RAW);
      if (RAW.length){
        PREMIUM_KEY = detectPremiumKey(RAW[0]) || "premium";
      } else {
        PREMIUM_KEY = "premium";
      }
      setStatus(msg + ` Using premium key: <code>${PREMIUM_KEY}</code>.`);
      renderAll();
    }

    // -------- Rendering --------
    function renderAll(){
      renderCarriers();
      renderPlans();
      renderPremiums();
    }

    function getKey(obj, candidates){ return pickKey(obj, candidates); }
    function getValue(obj, candidates){ const k = pickKey(obj, candidates); return k ? obj[k] : undefined; }

    // Carriers
    function renderCarriers(){
      const tbody = $("#carriers-table tbody");
      const table = $("#carriers-table");
      const empty = $("#carriers-empty");
      const q = ($("#carrier-filter").value||"").trim().toLowerCase();

      const rows = [];
      for (const p of RAW){
        const carrier = (getValue(p, CARRIER_KEY_CANDIDATES) ?? "Unknown").toString();
        const prem = toNum(p[PREMIUM_KEY]);
        const st = (getValue(p, STATE_KEY_CANDIDATES) ?? "").toString();
        rows.push({carrier, prem, st});
      }
      const byCarrier = new Map();
      rows.forEach(r=>{
        if(!byCarrier.has(r.carrier)) byCarrier.set(r.carrier, {count:0, prems:[], states:new Set()});
        const g = byCarrier.get(r.carrier);
        g.count++; if(isFinite(r.prem)) g.prems.push(r.prem);
        if(r.st) g.states.add(r.st);
      });

      let data = Array.from(byCarrier.entries()).map(([carrier,g])=>{
        const avg = g.prems.length ? g.prems.reduce((a,b)=>a+b,0)/g.prems.length : NaN;
        const min = g.prems.length ? Math.min(...g.prems) : NaN;
        const max = g.prems.length ? Math.max(...g.prems) : NaN;
        return {carrier, count:g.count, avg, min, max, states:Array.from(g.states).sort()};
      });

      if (q) data = data.filter(d=> d.carrier.toLowerCase().includes(q));

      data.sort((a,b)=> b.count - a.count || (a.carrier.localeCompare(b.carrier)));

      tbody.innerHTML = data.map(d=>`
        <tr>
          <td><span class="pill">${d.carrier}</span></td>
          <td>${d.count}</td>
          <td>${fmt$(d.avg)}</td>
          <td>${fmt$(d.min)}</td>
          <td>${fmt$(d.max)}</td>
          <td>${d.states.join(", ")||"—"}</td>
        </tr>
      `).join("");

      const has = data.length>0;
      table.classList.toggle("hidden", !has);
      empty.classList.toggle("hidden", has);
    }

    // Plans
    function renderPlans(){
      const head = $("#plans-head");
      const body = $("#plans-body");
      const table = $("#plans-table");
      const empty = $("#plans-empty");

      const q = ($("#plan-search").value||"").toLowerCase();
      const st = $("#state-select").value;

      // columns: prioritize useful ones but include whatever exists
      const baseCols = Array.from(new Set([
        pickKeySample(CARRIER_KEY_CANDIDATES) || "carrier",
        pickKeySample(PLANNAME_KEYS) || "planName",
        pickKeySample(CONTRACT_KEYS) || "contractId",
        pickKeySample(PLANID_KEYS) || "planId",
        pickKeySample(STATE_KEY_CANDIDATES) || "state",
        pickKeySample(COUNTY_KEY_CANDIDATES) || "county",
        PREMIUM_KEY
      ].filter(Boolean)));

      // plus a couple more discovered keys (up to 3)
      const extra = Array.from(KEYS).filter(k=>!baseCols.includes(k)).slice(0,3);
      const COLS = baseCols.concat(extra);

      head.innerHTML = COLS.map(c=>`<th>${c}</th>`).join("");

      let data = RAW.slice();

      if (st) {
        const k = pickKeySample(STATE_KEY_CANDIDATES);
        data = k ? data.filter(p => String(p[k]).toUpperCase() === st) : [];
      }

      if (q){
        const qn = Number.isNaN(Number(q)) ? null : Number(q);
        data = data.filter(p=>{
          const s = JSON.stringify(p).toLowerCase();
          if (s.includes(q)) return true;
          // also allow numeric search for premium matches
          if (qn!=null && isFinite(qn)){
            const v = toNum(p[PREMIUM_KEY]);
            return isFinite(v) && String(v).includes(String(qn));
          }
          return false;
        });
      }

      body.innerHTML = data.slice(0,2000).map(p=>{
        return `<tr>${COLS.map(c=>{
          const v = p[c];
          const isPrem = c===PREMIUM_KEY;
          return `<td>${isPrem?fmt$(toNum(v)):(v??"")}</td>`;
        }).join("")}</tr>`;
      }).join("");

      const has = data.length>0;
      table.classList.toggle("hidden", !has);
      empty.classList.toggle("hidden", has);

      // state dropdowns (populate once from RAW)
      const states = new Set();
      const stKey = pickKeySample(STATE_KEY_CANDIDATES);
      RAW.forEach(p=>{ if (stKey && p[stKey]) states.add(String(p[stKey]).toUpperCase()); });
      const opts = ['<option value="">All States</option>'].concat(
        Array.from(states).sort().map(s=>`<option value="${s}">${s}</option>`)
      ).join("");
      $("#state-select").innerHTML = opts;
      $("#prem-state").innerHTML = opts;
    }

    // Premiums
    function renderPremiums(){
      const st = $("#prem-state").value;
      const min = toNum($("#prem-min").value);
      const max = toNum($("#prem-max").value);

      const tbody = $("#prem-table tbody");
      const table = $("#prem-table");
      const empty = $("#prem-empty");

      let data = RAW.slice();

      if (st){
        const k = pickKeySample(STATE_KEY_CANDIDATES);
        data = k ? data.filter(p => String(p[k]).toUpperCase() === st) : [];
      }
      data = data.filter(p=>{
        const v = toNum(p[PREMIUM_KEY]);
        if (!isFinite(v)) return false;
        if (isFinite(min) && v < min) return false;
        if (isFinite(max) && v > max) return false;
        return true;
      });

      tbody.innerHTML = data.slice(0,2000).map(p=>{
        const carrier = getValue(p, CARRIER_KEY_CANDIDATES) ?? "";
        const plan = getValue(p, PLANNAME_KEYS) ?? "";
        const contract = getValue(p, CONTRACT_KEYS) ?? "";
        const planId = getValue(p, PLANID_KEYS) ?? "";
        const state = getValue(p, STATE_KEY_CANDIDATES) ?? "";
        const county = getValue(p, COUNTY_KEY_CANDIDATES) ?? "";
        const prem = fmt$(toNum(p[PREMIUM_KEY]));
        return `<tr>
          <td>${carrier}</td>
          <td>${plan}</td>
          <td>${contract}</td>
          <td>${planId}</td>
          <td>${state}</td>
          <td>${county}</td>
          <td>${prem}</td>
        </tr>`;
      }).join("");

      const has = data.length>0;
      table.classList.toggle("hidden", !has);
      empty.classList.toggle("hidden", has);

      // stats
      const vals = data.map(p=>toNum(p[PREMIUM_KEY])).filter(Number.isFinite);
      const avg = vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : NaN;
      const mn = vals.length ? Math.min(...vals) : NaN;
      const mx = vals.length ? Math.max(...vals) : NaN;
      $("#prem-count").textContent = data.length;
      $("#prem-avg").textContent = fmt$(avg);
      $("#prem-minmax").textContent = `${fmt$(mn)} — ${fmt$(mx)}`;
    }

    function pickKeySample(candidates){
      if (!RAW.length) return null;
      return pickKey(RAW[0], candidates);
    }

    // -------- Events --------
    $("#carrier-filter").addEventListener("input", renderCarriers);
    $("#plan-search").addEventListener("input", renderPlans);
    $("#state-select").addEventListener("change", renderPlans);

    $("#prem-state").addEventListener("change", renderPremiums);
    $("#prem-min").addEventListener("input", renderPremiums);
    $("#prem-max").addEventListener("input", renderPremiums);
    $("#prem-clear").addEventListener("click", ()=>{
      $("#prem-state").value = "";
      $("#prem-min").value = "";
      $("#prem-max").value = "";
      renderPremiums();
    });

    $("#file").addEventListener("change", async (e)=>{
      const f = e.target.files?.[0];
      if (!f) return;
      try{
        const txt = await f.text();
        const json = JSON.parse(txt);
        setData(json, `Loaded <code>${f.name}</code> (${json.length} plans).`);
      }catch(err){
        setStatus(`<span class="badge-bad">Failed to parse file:</span> ${String(err)}`);
      }
    });

    $("#reload").addEventListener("click", tryFetchDefault);

    // initial view
    const initial = (location.hash||"").replace("#","") || "premiums";
    show(VIEWS.includes(initial)?initial:"premiums");

    // kick off load
    tryFetchDefault();

    // -------- Small built-in sample (so the page always runs) --------
    function sampleData(){
      return [
        {
          "organization":"Acme Health",
          "planName":"Acme MA Classic (H1111-001)",
          "contractId":"H1111","planId":"001","state":"MN","county":"Hennepin",
          "premium":0, "moop":5900
        },
        {
          "organization":"Acme Health",
          "planName":"Acme MA Plus (H1111-002)",
          "contractId":"H1111","planId":"002","state":"MN","county":"Ramsey",
          "premium":29, "moop":4500
        },
        {
          "organization":"BetterCare",
          "planName":"BetterCare Gold (H2222-004)",
          "contractId":"H2222","planId":"004","state":"WI","county":"Dane",
          "monthlyPremium":49, "moop":3900
        },
        {
          "organization":"BetterCare",
          "planName":"BetterCare Silver (H2222-003)",
          "contractId":"H2222","planId":"003","state":"WI","county":"Milwaukee",
          "monthlyPremium":19, "moop":5500
        }
      ];
    }
  </script>
</body>
</html>
