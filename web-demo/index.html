<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Medicare Advantage Carrier Lookup (Static JSON)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --border: #e5e7eb;
      --muted: #666;
      --bg: #f9fafb;
      --bg-hover: #f3f4f6;
      --danger: #b00;
      --pad: 24px;
    }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: var(--pad); }
    h1 { margin: 0 0 16px; font-size: 20px; }
    label { margin-right: 12px; display: inline-flex; gap: 8px; align-items: center; }
    input, select, button { font-size: 16px; padding: 6px 10px; }
    button { cursor: pointer; }
    #msg { margin: 16px 0; color: var(--danger); white-space: pre-wrap; }
    #out { margin-top: 12px; }
    .carrier { padding: 8px 0; border-bottom: 1px solid #eee; }
    .badge { font-size: 12px; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; margin-left: 6px; }
    .muted { color: var(--muted); font-size: 13px; }

    /* plan chip */
    .plan-chip {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 3px 8px; margin: 4px 6px 0 0;
      border: 1px solid var(--border); border-radius: 9999px;
      background: var(--bg); font-size: 12px; cursor: pointer;
      user-select: none;
    }
    .plan-chip:hover { background: var(--bg-hover); }
    .carrier .name { cursor: pointer; }
  </style>

  <!-- Optional (your implementations) -->
  <link rel="stylesheet" href="plan-viewer.css" />
  <script src="plan-viewer.js" defer></script>
  <script src="plan-picker.js" defer></script>
</head>

<body>
  <h1>Medicare Advantage Carrier Lookup (Static JSON)</h1>

  <div role="form" aria-label="Lookup">
    <label for="zip">ZIP
      <input id="zip" placeholder="e.g., 55379" inputmode="numeric" maxlength="5" />
    </label>
    <label for="year">Year
      <select id="year">
        <option value="2025" selected>2025</option>
      </select>
    </label>
    <button id="go" type="button">Lookup</button>
  </div>

  <div id="msg" class="muted" aria-live="polite"></div>
  <div id="out"></div>

  <script type="module">
    // Safe guards if external scripts aren't present
    const PlanViewer = (globalThis.PlanViewer ?? {
      init(){}, register(node, plan){ node.addEventListener('click', () => alert('PlanViewer not loaded.\n\n' + JSON.stringify(plan, null, 2))); }
    });
    const PlanPicker = (globalThis.PlanPicker ?? {
      open(plans, opts){ alert((opts?.title || 'Choose a plan') + '\n\n' + plans.map(p => (p.contract || p.contractId) + ' ' + (p.pbp || p.planId)).join('\n')); }
    });

    // Compute BASE so it works on GitHub Pages (subfolder) or locally
    const BASE = (() => {
      const { origin, pathname } = location;
      // If this page is /web-demo/..., strip from /web-demo/ onward; else use folder of current file.
      const m = pathname.match(/^(.*?)(\/web-demo\/.*)$/);
      if (m) return origin + m[1] + '/';
      return origin + pathname.replace(/[^/]*$/, ''); // current dir
    })();

    const $ = (id) => document.getElementById(id);
    const $msg = () => $('msg');
    const $out = () => $('out');

    const normalizeZip = (z) => String(z ?? '').replace(/\D/g, '').padStart(5, '0');

    async function fetchJson(url) {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText} @ ${url}`);
      return res.json();
    }

    async function loadZipIndex(year) {
      return fetchJson(`${BASE}years/${year}/zip-index.json`);
    }

    async function tryFetch(url) {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return { json: await res.json(), url };
    }

    // Optional helper if you want to deep-load a plan JSON by contract/PBP
    async function loadPlanJSON(contract, pbp, year) {
      const candidates = [
        `${BASE}years/${year}/by-plan/${contract}-${pbp}.json`,
        `${BASE}years/${year}/plans/${contract}-${pbp}.json`,
        `${BASE}years/${year}/plans/${contract}/${pbp}.json`,
        `${BASE}years/${year}/plan-details/${contract}-${pbp}.json`,
      ];
      const errors = [];
      for (const u of candidates) {
        try { return await tryFetch(u); } catch (e) { errors.push(`${u} → ${e.message}`); }
      }
      throw new Error(`No plan JSON found.\nTried:\n- ${errors.join('\n- ')}`);
    }

    function renderCountySummary(parent, county) {
      const header = document.createElement('h3');
      header.textContent = `${county.county_name}, ${county.state} — ${(county.carriers?.length ?? 0)} carriers`;
      parent.appendChild(header);

      (county.carriers ?? []).forEach(c => {
        const row = document.createElement('div');
        row.className = 'carrier';

        // Top line
        const top = document.createElement('div');

        const name = document.createElement('strong');
        name.className = 'name';
        name.textContent = c.orgName || 'Carrier';
        name.title = 'Click to choose a plan';
        name.tabIndex = 0;
        name.addEventListener('click', () => {
          const plans = Array.isArray(c.plans) ? c.plans : [];
          PlanPicker.open(plans, { title: `${c.orgName || 'Carrier'} — choose a plan` });
        });
        name.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); name.click(); }
        });

        const contracts = document.createElement('span');
        contracts.className = 'badge';
        const ids = Array.isArray(c.contractIds) ? c.contractIds.join(', ') : '';
        contracts.textContent = ids;

        const count = document.createElement('span');
        count.className = 'muted';
        const n = (c.plans ?? []).length;
        count.textContent = ` — ${n} plan${n === 1 ? '' : 's'}`;

        top.appendChild(name);
        if (ids) top.appendChild(contracts);
        top.appendChild(count);
        row.appendChild(top);

        // Plan chips
        if (Array.isArray(c.plans) && c.plans.length) {
          const chips = document.createElement('div');
          c.plans.forEach(p => {
            const chip = document.createElement('button');
            chip.type = 'button';
            chip.className = 'plan-chip';
            const contract = p.contract || p.contractId || p.contract_id || '';
            const pbp = p.pbp || p.planId || p.plan_id || '';
            chip.textContent = `${contract}${pbp ? ' ' + pbp : ''}`.trim();

            // Register with your viewer (opens a drawer/modal, etc.)
            PlanViewer.register(chip, p, {
              title: `${contract}${pbp ? ' - ' + pbp : ''}`,
              hint: 'source: county JSON'
            });

            chips.appendChild(chip);
          });
          row.appendChild(chips);
        }

        parent.appendChild(row);
      });
    }

    async function lookup() {
      const msg = $msg();
      const out = $out();
      msg.textContent = '';
      out.innerHTML = '';

      const year = $('year').value;
      const zip = normalizeZip($('zip').value);

      if (!/^\d{5}$/.test(zip)) {
        msg.textContent = 'Please enter a 5-digit ZIP.';
        return;
      }

      try {
        // 1) ZIP → candidate counties
        const idx = await loadZipIndex(year);
        const rec = idx.find(e => e.zip === zip);
        if (!rec) {
          msg.textContent = `ZIP ${zip} is not in the index. Try a nearby residential ZIP (not PO Box).`;
          return;
        }
        if (!(rec.counties?.length)) {
          msg.textContent = `ZIP ${zip} returned no counties.`;
          return;
        }

        // 2) Choose top county by share
        const [fips] = rec.counties[0];
        const countyUrl = `${BASE}years/${year}/by-county/${fips}.json`;

        // 3) Fetch + 4) Render
        const county = await fetchJson(countyUrl);
        renderCountySummary(out, county);

        // 5) Note if multiple counties
        if (rec.counties.length > 1) {
          const hint = document.createElement('div');
          hint.className = 'muted';
          const other = rec.counties.slice(1).map(([f]) => f).join(', ');
          hint.textContent = `Note: ZIP ${zip} spans multiple counties; showing top match FIPS ${fips}. Others: ${other || '—'}.`;
          out.appendChild(hint);
        }
      } catch (err) {
        msg.textContent = 'Error: ' + (err?.message || err);
      }
    }

    function init() {
      // If your PlanViewer exposes init, call it
      if (typeof PlanViewer.init === 'function') {
        try { PlanViewer.init(); } catch {}
      }

      $('go').addEventListener('click', lookup);
      $('zip').addEventListener('keydown', (e) => { if (e.key === 'Enter') lookup(); });
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
