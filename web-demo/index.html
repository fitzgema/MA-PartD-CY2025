<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Medicare Advantage Carrier Lookup (Static JSON)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --border:#e5e7eb; --muted:#666; --bg:#f9fafb; --bg-hover:#f3f4f6; --danger:#b00; --ok:#157347; --pad:24px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: var(--pad); }
    h1 { margin: 0 0 16px; font-size: 22px; }
    label { margin-right: 12px; display: inline-flex; gap: 8px; align-items: center; }
    input, select, button, textarea { font-size: 16px; padding: 6px 10px; }
    button { cursor: pointer; }
    #msg { margin: 16px 0; color: var(--danger); white-space: pre-wrap; }
    #out { margin-top: 12px; }
    .row { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .carrier { padding: 8px 0; border-bottom: 1px solid #eee; }
    .badge { font-size: 12px; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; margin-left: 6px; }
    .muted { color: var(--muted); font-size: 13px; }
    .btn-secondary { border:1px solid var(--border); background:#fafafa; border-radius:8px; padding:6px 10px; font-size:13px; }
    .plan-chip { display:inline-flex; align-items:center; gap:6px; padding:3px 8px; margin:4px 6px 0 0; border:1px solid var(--border); border-radius:9999px; background:var(--bg); font-size:12px; cursor:pointer; user-select:none; }
    .plan-chip:hover { background:var(--bg-hover); }
    .carrier .name { cursor: pointer; }

    /* Data source panel */
    details#ds { margin-top: 10px; }
    #bases { width: min(880px, 96vw); font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    #basesInfo { margin-top: 6px; font-size: 12px; color: #555; white-space: pre-wrap; }
  </style>

  <!-- Assets live alongside this file in web-demo/ -->
  <link rel="stylesheet" href="plan-viewer.css" />
  <script src="plan-viewer.js" defer></script>
  <script src="plan-picker.js" defer></script>
</head>

<body>
  <h1>Medicare Advantage Carrier Lookup (Static JSON)</h1>

  <div role="form" aria-label="Lookup" class="row">
    <label for="zip">ZIP
      <input id="zip" placeholder="e.g., 55379" inputmode="numeric" maxlength="5" />
    </label>
    <label for="year">Year
      <select id="year">
        <option value="2025" selected>2025</option>
      </select>
    </label>
    <button id="go" type="button">Lookup</button>
    <button id="dump" type="button" class="btn-secondary" title="Print all embedded plan JSON below">Show all plan JSON (dump)</button>
  </div>

  <!-- Data source controls: paste one or more dataset bases (pipe/comma separated). Saved to localStorage. -->
  <details id="ds">
    <summary>Data source (advanced)</summary>
    <div class="row" style="margin-top:8px;">
      <input id="bases" placeholder="e.g. https://cdn.jsdelivr.net/gh/<user>/<repo>@main/ | https://raw.githubusercontent.com/<user>/<repo>/main/" />
      <button id="apply" type="button">Apply</button>
      <button id="reset" type="button">Reset</button>
      <button id="test" type="button">Test</button>
    </div>
    <div id="basesInfo" class="muted"></div>
  </details>

  <div id="msg" class="muted" aria-live="polite"></div>
  <div id="out"></div>
  <div id="dumpZone"></div>

  <script type="module">
    // ----------------- Utilities -----------------
    const $ = (id) => document.getElementById(id);
    const setMsg = (t, color='#b00') => { const m = $('msg'); m.style.color=color; m.textContent = t; };
    const info = (t) => setMsg(t, '#555');
    const ok = (t) => setMsg(t, 'var(--ok)');
    const pad3 = (v) => String(v ?? '').replace(/\D/g, '').padStart(3, '0');
    const normalizeZip = (z) => String(z ?? '').replace(/\D/g, '').padStart(5, '0');

    if (location.protocol === 'file:') {
      info('⚠️ file:// detected. Use a local server (e.g., `npx serve`) so fetch() can load JSON.');
    }

    // ----------------- Multi-source dataset bases -----------------
    // Repo root (even though this file lives in /web-demo/)
    const PAGES_BASE = (() => {
      const { origin, pathname } = location;
      const m = pathname.match(/^(.*?)(\/web-demo\/.*)$/);
      return origin + (m ? m[1] + '/' : pathname.replace(/[^/]*$/, ''));
    })();

    // Infer <user>/<repo> for CDN/raw
    const GH_USER = location.hostname.endsWith('github.io') ? location.hostname.split('.')[0] : null;
    const GH_REPO = (location.pathname.split('/')[1] || '').trim();
    const CDN_BASE = (GH_USER && GH_REPO) ? `https://cdn.jsdelivr.net/gh/${GH_USER}/${GH_REPO}@main/` : null;
    const RAW_BASE = (GH_USER && GH_REPO) ? `https://raw.githubusercontent.com/${GH_USER}/${GH_REPO}/main/` : null;

    const addSlash = (s) => s ? (s.endsWith('/') ? s : s + '/') : s;
    const parseList = (s) => (s || '').split(/[|,;\s]+/).map(x => addSlash(x.trim())).filter(Boolean);

    // Allow override via ?data=
    const QUERY_BASES = parseList(new URLSearchParams(location.search).get('data') || '');
    const SAVED_BASES = parseList(localStorage.getItem('dataBases') || '');

    // Known optional fallbacks (edit/remove if you don't use them)
    const KNOWN_FALLBACKS = [
      // Example external dataset repo(s). Leave empty or replace with your actual dataset repo(s).
      // 'https://cdn.jsdelivr.net/gh/youruser/your-dataset-repo@main/',
      // 'https://raw.githubusercontent.com/youruser/your-dataset-repo/main/'
    ];

    let DATA_BASES = Array.from(new Set(
      [PAGES_BASE, ...QUERY_BASES, ...SAVED_BASES, CDN_BASE, RAW_BASE, ...KNOWN_FALLBACKS]
        .filter(Boolean)
        .map(addSlash)
    ));

    function refreshBasesInfo() {
      $('bases').value = DATA_BASES.join(' | ');
      $('basesInfo').textContent = 'Active bases (in order):\n' + DATA_BASES.join('\n');
    }
    function setBases(list) {
      DATA_BASES = Array.from(new Set(list.filter(Boolean).map(addSlash)));
      localStorage.setItem('dataBases', DATA_BASES.join('|'));
      refreshBasesInfo();
    }
    refreshBasesInfo();

    async function fetchJsonFromAny(relPath) {
      const errors = [];
      for (const base of DATA_BASES) {
        const url = base + relPath;
        try {
          const r = await fetch(url, { cache: 'no-store' });
          if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
          return { json: await r.json(), url };
        } catch (e) { errors.push(`- ${url} → ${e.message}`); }
      }
      throw new Error(`All sources failed for ${relPath}:\n${errors.join('\n')}`);
    }

    const loadZipIndex = (year) => fetchJsonFromAny(`years/${year}/zip-index.json`).then(r => r.json);

    // ---------- Full plan loader (tries many filenames) ----------
    function extractIds(plan) {
      const year = $('year')?.value || '2025';
      const contract = (plan.contract || plan.contractId || plan.contract_id || plan.ContractID || '').toString().toUpperCase().trim();
      const pbp = pad3(plan.pbp ?? plan.planId ?? plan.plan_id ?? plan.PBP ?? '');
      const segment = pad3(plan.segmentId ?? plan.segment_id ?? plan.segment ?? '000');
      const cmsKey = plan.cmsPlanKey || plan.CMSPlanKey || `${year}-${contract}-${pbp}-${segment}`;
      return { year, contract, pbp, segment, cmsKey };
    }

    function relPlanPaths({ year, contract, pbp, segment, cmsKey }) {
      const y = year, c = contract, p = pbp, s = segment || '000';
      return [
        `years/${y}/by-plan/${c}-${p}-${s}.json`,
        `years/${y}/plan-details/${c}-${p}-${s}.json`,
        `years/${y}/plans/${c}-${p}-${s}.json`,
        `years/${y}/by-plan/${c}/${p}-${s}.json`,
        `years/${y}/by-plan/${c}/${p}/${s}.json`,
        `years/${y}/plans/${c}/${p}-${s}.json`,
        `years/${y}/plans/${c}/${p}/${s}.json`,
        `years/${y}/by-plan/${cmsKey}.json`,
        `years/${y}/plan-details/${cmsKey}.json`,
        `years/${y}/plans/${cmsKey}.json`,
        `years/${y}/by-plan/${c}-${p}.json`,
        `years/${y}/plan-details/${c}-${p}.json`,
        `years/${y}/plans/${c}-${p}.json`,
        `years/${y}/by-plan/${c}/${p}.json`,
        `years/${y}/plans/${c}/${p}.json`,
        `years/${y}/by-plan/${c}-${p}-${s}.min.json`,
        `years/${y}/by-plan/${c}-${p}.min.json`,
      ];
    }

    async function loadFullPlan(planOrIds) {
      const ids = ('contract' in planOrIds && 'pbp' in planOrIds && 'year' in planOrIds)
        ? planOrIds
        : extractIds(planOrIds);
      const errors = [];
      for (const rel of relPlanPaths(ids)) {
        try {
          const { json, url } = await fetchJsonFromAny(rel);
          return { json, url };
        } catch (e) { errors.push(e.message); }
      }
      throw new Error(`No plan JSON found for ${ids.contract}-${ids.pbp}. Last errors:\n- ${errors.slice(-5).join('\n- ')}`);
    }

    // Expose to external plan-picker.js (optional)
    window.__loadPlanJSON = async (contract, pbp, year, segment='000', cmsKey=null) => {
      const ids = {
        contract: (contract||'').toString().toUpperCase().trim(),
        pbp: pad3(pbp),
        year: year || $('year')?.value || '2025',
        segment: pad3(segment || '000'),
        cmsKey: cmsKey || `${year || $('year')?.value || '2025'}-${(contract||'').toString().toUpperCase().trim()}-${pad3(pbp)}-${pad3(segment||'000')}`
      };
      return loadFullPlan(ids);
    };

    // ----------------- Rendering -----------------
    let LAST_COUNTY = null;

    function renderCountySummary(parent, county) {
      LAST_COUNTY = county;
      parent.innerHTML = '';
      if (!county) return setMsg('County JSON empty.');

      const header = document.createElement('h3');
      header.textContent = `${county.county_name}, ${county.state} — ${(county.carriers?.length ?? 0)} carriers`;
      parent.appendChild(header);

      const carriers = county.carriers ?? [];
      if (!carriers.length) { return setMsg('No carriers found in county JSON.'); }

      carriers.forEach(c => {
        const row = document.createElement('div');
        row.className = 'carrier';

        const top = document.createElement('div'); top.className='row';

        const name = document.createElement('strong');
        name.className = 'name';
        name.textContent = c.orgName || 'Carrier';
        name.title = 'Click to choose a plan';
        name.tabIndex = 0;
        name.addEventListener('click', () => {
          const plans = Array.isArray(c.plans) ? c.plans : [];
          if (window.PlanPicker?.open) {
            PlanPicker.open(plans, { title: `${c.orgName || 'Carrier'} — choose a plan` });
          }
        });
        name.addEventListener('keydown', (e) => { if (e.key==='Enter'||e.key===' ') { e.preventDefault(); name.click(); } });

        const idsTxt = Array.isArray(c.contractIds) ? c.contractIds.join(', ') : '';
        const contracts = document.createElement('span');
        contracts.className = 'badge';
        contracts.textContent = idsTxt;

        const count = document.createElement('span');
        count.className = 'muted';
        const plansArray = (c.plans ?? []);
        const n = plansArray.length;
        count.textContent = ` — ${n} plan${n === 1 ? '' : 's'}`;

        top.appendChild(name);
        if (idsTxt) top.appendChild(contracts);
        top.appendChild(count);
        row.appendChild(top);

        if (n) {
          const chips = document.createElement('div');
          plansArray.forEach(p => {
            const ids = extractIds(p);
            const premium = p.premium ?? p.monthly_premium ?? p.premiumMonthly ?? p.premium_total ?? null;

            const chip = document.createElement('button');
            chip.type = 'button';
            chip.className = 'plan-chip';
            chip.textContent = `${ids.contract} ${ids.pbp}${premium!=null ? ` — $${Number(premium).toFixed(2)}/mo` : ''}`;

            const loader = async () => {
              try {
                const { json, url } = await loadFullPlan(p);
                return { __provenance: url, ...json };
              } catch {
                return { __provenance: 'county JSON (fallback)', ...p };
              }
            };

            if (window.PlanViewer?.register) {
              PlanViewer.register(chip, loader, {
                title: `${ids.contract} - ${ids.pbp}`,
                hint: 'Prefers full plan file; falls back to county JSON'
              });
            } else {
              chip.addEventListener('click', async () => {
                const data = await loader();
                window.PlanViewer?.show?.(data, { title: `${ids.contract} - ${ids.pbp}`, hint: data.__provenance });
              });
            }
            chips.appendChild(chip);
          });
          row.appendChild(chips);
        } else {
          const none = document.createElement('div');
          none.className = 'muted';
          none.textContent = 'No plans listed for this carrier.';
          row.appendChild(none);
        }

        parent.appendChild(row);
      });
    }

    async function lookup() {
      $('msg').textContent = ''; $('out').innerHTML = ''; $('dumpZone').innerHTML = '';
      const year = $('year').value;
      const zip = normalizeZip($('zip').value);
      if (!/^\d{5}$/.test(zip)) return setMsg('Please enter a 5-digit ZIP.');

      try {
        const idx = await loadZipIndex(year);
        const rec = idx.find(e => e.zip === zip);
        if (!rec) return setMsg(`ZIP ${zip} is not in the index. Try a nearby residential ZIP (not PO Box).`);
        if (!(rec.counties?.length)) return setMsg(`ZIP ${zip} returned no counties.`);

        const [fips] = rec.counties[0];
        const { json: county, url } = await fetchJsonFromAny(`years/${year}/by-county/${fips}.json`);
        console.log('County from:', url);
        renderCountySummary($('out'), county);

        if (rec.counties.length > 1) {
          const hint = document.createElement('div');
          hint.className = 'muted';
          const other = rec.counties.slice(1).map(([f]) => f).join(', ');
          hint.textContent = `Note: ZIP ${zip} spans multiple counties; showing top match FIPS ${fips}. Others: ${other || '—'}.`;
          $('out').appendChild(hint);
        }
        ok(`Loaded county ${fips}. Click a carrier or plan chip.`);
      } catch (e) {
        console.error(e); setMsg('Error: ' + (e?.message || e));
      }
    }

    function dumpAllPlans() {
      $('dumpZone').innerHTML = '';
      if (!LAST_COUNTY) { return setMsg('Load a ZIP first, then click "Show all plan JSON".'); }
      const carriers = LAST_COUNTY.carriers ?? [];
      const allPlans = carriers.flatMap(c => Array.isArray(c.plans) ? c.plans : []);
      if (!allPlans.length) { return setMsg('This county JSON does not embed plan objects. No plan data to dump.'); }
      const pre = document.createElement('pre');
      pre.style.font = '12px/1.5 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace';
      pre.style.background = '#fafafa'; pre.style.border = '1px solid #eee';
      pre.style.padding = '10px'; pre.style.borderRadius = '8px'; pre.style.whiteSpace = 'pre-wrap';
      pre.textContent = JSON.stringify(allPlans, null, 2);
      $('dumpZone').appendChild(pre);
      info(`Dumped ${allPlans.length} plan objects below.`);
    }

    // Data source UI
    $('apply').onclick = () => setBases(parseList($('bases').value));
    $('reset').onclick = () => setBases([PAGES_BASE, CDN_BASE, RAW_BASE].filter(Boolean));
    $('test').onclick = async () => {
      $('msg').textContent = '';
      try {
        const y = $('year').value;
        const { url } = await fetchJsonFromAny(`years/${y}/zip-index.json`);
        ok(`OK: ${url}`);
      } catch (e) { setMsg('Error: ' + (e?.message || e)); }
    };

    // Wire up
    window.addEventListener('DOMContentLoaded', () => {
      if (typeof PlanViewer?.init === 'function') { try { PlanViewer.init(); } catch {} }
      $('go').addEventListener('click', lookup);
      $('zip').addEventListener('keydown', (e) => { if (e.key === 'Enter') lookup(); });
      $('dump').addEventListener('click', dumpAllPlans);
    });
  </script>
</body>
</html>
