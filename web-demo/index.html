<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Medicare Advantage Carrier Lookup (Static JSON)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 16px; }
    label { margin-right: 12px; }
    input, select, button { font-size: 16px; padding: 6px 10px; }
    #msg { margin: 16px 0; color: #b00; }
    #out { margin-top: 12px; }
    .carrier { padding: 8px 0; border-bottom: 1px solid #eee; }
    .badge { font-size: 12px; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; margin-left: 6px; }
    .muted { color: #666; font-size: 13px; }

    /* NEW: simple plan chip */
    .plan-chip {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 3px 8px; margin: 4px 6px 0 0;
      border: 1px solid #e5e7eb; border-radius: 9999px;
      background: #f9fafb; font-size: 12px; cursor: pointer;
      user-select: none;
    }
    .plan-chip:hover { background: #f3f4f6; }
    .carrier .name { cursor: pointer; } /* for PlanPicker */
  </style>

  <link rel="stylesheet" href="plan-viewer.css" />
  <script src="plan-viewer.js" defer></script>
  <script src="plan-picker.js" defer></script>
</head>

<body>
  <h1>Medicare Advantage Carrier Lookup (Static JSON)</h1>

  <div>
    <label>ZIP
      <input id="zip" placeholder="e.g., 55379" inputmode="numeric" maxlength="5" />
    </label>
    <label>Year
      <select id="year">
        <option value="2025" selected>2025</option>
      </select>
    </label>
    <button id="go">Lookup</button>
  </div>

  <div id="msg" class="muted"></div>
  <div id="out"></div>

  <script>
    // Initialize the viewer when DOM is ready
    window.addEventListener('DOMContentLoaded', () => PlanViewer.init());

    // Compute base like: https://fitzgema.github.io/MA-PartD-CY2025/
    const BASE = location.origin + location.pathname.replace(/\/web-demo\/.*/, '/');

    function normalizeZip(z) {
      return String(z || '').replace(/\D/g, '').padStart(5, '0');
    }

    async function fetchJson(url) {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(res.status + ' ' + res.statusText + ' @ ' + url);
      return res.json();
    }

    async function loadZipIndex(year) {
      return fetchJson(`${BASE}years/${year}/zip-index.json`);
    }

    // UPDATED: render carriers with clickable name (PlanPicker) + per-plan chips that open PlanViewer
    function renderCountySummary(parent, county) {
      const header = document.createElement('h3');
      header.textContent = `${county.county_name}, ${county.state} — ${county.carriers?.length || 0} carriers`;
      parent.appendChild(header);

      (county.carriers || []).forEach(c => {
        const row = document.createElement('div');
        row.className = 'carrier';

        // Top line: carrier name (click to open PlanPicker) + contracts + count
        const name = document.createElement('strong');
        name.className = 'name';
        name.textContent = c.orgName || 'Carrier';
        name.title = 'Click to choose a plan';
        name.addEventListener('click', () => {
          const plans = Array.isArray(c.plans) ? c.plans : [];
          PlanPicker.open(plans, { title: `${c.orgName || 'Carrier'} — choose a plan` });
        });

        const contracts = document.createElement('span');
        contracts.className = 'badge';
        contracts.textContent = Array.isArray(c.contractIds) ? c.contractIds.join(', ') : '';

        const count = document.createElement('span');
        count.className = 'muted';
        const n = (c.plans || []).length;
        count.textContent = ` — ${n} plan${n === 1 ? '' : 's'}`;

        const top = document.createElement('div');
        top.appendChild(name);
        if (contracts.textContent) top.appendChild(contracts);
        top.appendChild(count);
        row.appendChild(top);

        // Chips for each plan (if present in JSON)
        if (Array.isArray(c.plans) && c.plans.length) {
          const chips = document.createElement('div');
          c.plans.forEach(p => {
            const chip = document.createElement('span');
            chip.className = 'plan-chip';
            const contract = p.contract || p.contractId || p.contract_id || '';
            const pbp = p.pbp || p.planId || p.plan_id || '';
            chip.textContent = `${contract}${pbp ? ' ' + pbp : ''}`.trim();

            // Open the plan drawer with the raw object we already have
            PlanViewer.register(chip, p, {
              title: `${contract}${pbp ? ' - ' + pbp : ''}`,
              // hint can help QA provenance; here the data comes from the county JSON
              hint: 'source: county JSON'
            });

            chips.appendChild(chip);
          });
          row.appendChild(chips);
        }

        parent.appendChild(row);
      });
    }

    async function lookup() {
      const msg = document.getElementById('msg');
      const out = document.getElementById('out');
      msg.textContent = '';
      out.innerHTML = '';

      const year = document.getElementById('year').value;
      const zip = normalizeZip(document.getElementById('zip').value);

      if (!/^\d{5}$/.test(zip)) {
        msg.textContent = 'Please enter a 5-digit ZIP.';
        return;
      }

      try {
        // 1) Find candidate counties for ZIP
        const idx = await loadZipIndex(year);
        const rec = idx.find(e => e.zip === zip);
        if (!rec) {
          msg.textContent = `ZIP ${zip} is not in the index. Try a nearby residential ZIP (not PO Box).`;
          return;
        }
        if (!rec.counties?.length) {
          msg.textContent = `ZIP ${zip} returned no counties.`;
          return;
        }

        // 2) Pick the top county by share (simplest for demo)
        const [fips /*, share */] = rec.counties[0];
        const countyUrl = `${BASE}years/${year}/by-county/${fips}.json`;

        // 3) Fetch county carriers (+ embedded plans if present)
        const county = await fetchJson(countyUrl);

        // 4) Render
        renderCountySummary(out, county);

        // 5) If ZIP spans multiple counties, show a helpful hint
        if (rec.counties.length > 1) {
          const hint = document.createElement('div');
          hint.className = 'muted';
          const other = rec.counties.slice(1).map(([f]) => f).join(', ');
          hint.textContent = `Note: ZIP ${zip} spans multiple counties; showing top match FIPS ${fips}. Others: ${other || '—'}.`;
          out.appendChild(hint);
        }
      } catch (err) {
        msg.textContent = 'Error: ' + (err?.message || err);
      }
    }

    document.getElementById('go').addEventListener('click', lookup);
    document.getElementById('zip').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') lookup();
    });
  </script>
</body>
</html>
