<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Medicare Advantage Carrier Lookup (Static JSON)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 16px; }
    label { margin-right: 12px; }
    input, select, button { font-size: 16px; padding: 6px 10px; }
    #msg { margin: 16px 0; color: #b00; }
    #out { margin-top: 12px; }
    .carrier { padding: 8px 0; border-bottom: 1px solid #eee; }
    .badge { font-size: 12px; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; margin-left: 6px; }
    .muted { color: #666; font-size: 13px; }

    /* NEW: simple plan chip */
    .plan-chip {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 3px 8px; margin: 4px 6px 0 0;
      border: 1px solid #e5e7eb; border-radius: 9999px;
      background: #f9fafb; font-size: 12px; cursor: pointer;
      user-select: none;
    }
    .plan-chip:hover { background: #f3f4f6; }
    .carrier .name { cursor: pointer; } /* for PlanPicker */
  </style>

  <link rel="stylesheet" href="plan-viewer.css" />
  <script src="plan-viewer.js" defer></script>
  <script src="plan-picker.js" defer></script>
</head>

<body>
  <h1>Medicare Advantage Carrier Lookup (Static JSON)</h1>

  <div>
    <label>ZIP
      <input id="zip" placeholder="e.g., 55379" inputmode="numeric" maxlength="5" />
    </label>
    <label>Year
      <select id="year">
        <option value="2025" selected>2025</option>
      </select>
    </label>
    <button id="go">Lookup</button>
  </div>

  <div id="msg" class="muted"></div>
  <div id="out"></div>

  <script>
    // Initialize the viewer when DOM is ready
    window.addEventListener('DOMContentLoaded', () => PlanViewer.init());

    // Compute base like: https://fitzgema.github.io/MA-PartD-CY2025/
    const BASE = location.origin + location.pathname.replace(/\/web-demo\/.*/, '/');

    function normalizeZip(z) {
      return String(z || '').replace(/\D/g, '').padStart(5, '0');
    }

    async function fetchJson(url) {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(res.status + ' ' + res.statusText + ' @ ' + url);
      return res.json();
    }

    async function loadZipIndex(year) {
      return fetchJson(`${BASE}years/${year}/zip-index.json`);
    }

    // UPDATED: render carriers with clickable name (PlanPicker) + per-plan chips that open PlanViewer
    function renderCountySummary(parent, county) {
      const header = document.createElement('h3');
      header.textContent = `${county.county_name}, ${county.state} — ${county.carriers?.length || 0} carriers`;
      parent.appendChild(header);

      (county.carriers || []).forEach(c => {
        const row = document.createElement('div');
        row.className = 'carrier';

        // Top line: carrier name (click to open PlanPicker) + contracts + count
        const name = document.createElement('strong');
        name.className = 'name';
        name.textContent = c.orgName || 'Carrier';
        name.title = 'Click to choose a plan';
        name.addEventListener('click', () => {
          const plans = Array.isArray(c.plans) ? c.plans : [];
          PlanPicker.open(plans, { title: `${c.orgName || 'Carrier'} — choose a plan` });
        });

        const contracts = document.createElement('span');
        contracts.className = 'badge';
        contracts.textContent = Array.isArray(c.contractIds) ? c.contractIds.join(', ') : '';

        const count = document.createElement('span');
        count.className = 'muted';
        const n = (c.plans || []).length;
        count.textContent = ` — ${n} plan${n ===
